<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Rapporto Intervento ‚Äì 2M Digital Consulting SRLS</title>
  <style>
    /* ====== LIGHT THEME WITH STRONG CONTRAST (WCAG-friendly) ====== */
    :root{
      --bg:#f7f8fb;          /* page background */
      --card:#ffffff;        /* card background */
      --ink:#111827;         /* main text */
      --muted:#374151;       /* secondary text */
      --border:#e5e7eb;      /* card & field borders */
      --field:#ffffff;       /* field bg */
      --accent:#2563eb;      /* primary blue */
      --accent-2:#16a34a;    /* success green */
      --danger:#dc2626;      /* danger red */
      --shadow: 0 10px 24px rgba(17,24,39,0.08);
      --radius:16px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
    html,body{height:100%}
    html{background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;-webkit-text-size-adjust:100%}
    body{margin:0;display:flex;justify-content:center}
    .wrap{
      width:100%;max-width:820px;
      padding-top:calc(36px + env(safe-area-inset-top));
      padding-right:env(safe-area-inset-right);
      padding-left:env(safe-area-inset-left);
      padding-bottom:calc(96px + env(safe-area-inset-bottom)); /* leave room for sticky bar */
    }
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .logo{
      width:44px;height:44px;border-radius:12px;
      background: linear-gradient(135deg,#60a5fa,#34d399);
      display:grid;place-items:center;font-weight:800;color:#0b1020;letter-spacing:.3px;
      box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    h1{font-size:1.28rem;line-height:1.2;margin:0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    form{display:grid;gap:14px}
    label{display:block;font-size:1rem;color:var(--muted);margin-bottom:7px}
    input[type="text"],input[type="email"],input[type="datetime-local"],textarea{
      width:100%;padding:14px 15px;border-radius:12px;border:1px solid #d1d5db;background:var(--field);color:var(--ink);
      outline:none;font-size:16px; /* prevents iOS zoom */
    }
    input:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(37,99,235,.18)}
    textarea{min-height:150px;resize:vertical}
    .row{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
    .inline{display:flex;align-items:center;gap:12px}
    .inline input[type="checkbox"]{width:22px;height:22px}
    .totale{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#f3f4f6;border:1px solid var(--border);border-radius:12px}
    .pill{padding:6px 10px;border-radius:999px;background:#e0e7ff;color:#1e3a8a;font-weight:800}
    .preview{white-space:pre-wrap;background:#f9fafb;border:1px dashed #d1d5db;border-radius:12px;padding:12px;font-size:1rem;color:#111827}
    footer{margin-top:16px;color:var(--muted);font-size:.95rem;text-align:center}

    /* ===== Sticky action bar for thumb reach on iPhone ===== */
    .actions-sticky{
      position:fixed;left:0;right:0;bottom:0;z-index:10;
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.96);backdrop-filter:saturate(120%) blur(6px);
      border-top:1px solid var(--border);
      display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr;gap:10px;
    }
    @media(max-width:480px){
      .actions-sticky{grid-template-columns:1.4fr 1fr 1fr 1fr}
    }
    button{
      appearance:none;border:1px solid #cbd5e1;border-radius:12px;padding:14px 12px;font-weight:800;cursor:pointer;font-size:16px;
      transition:transform .06s ease, opacity .15s ease;background:#ffffff;color:#0b1324;
    }
    button:active{transform:scale(.98)}
    .primary{background:var(--accent);color:#ffffff;border-color:var(--accent)}
    .ghost{background:#ffffff;color:#111827}
    .success{background:var(--accent-2);color:#ffffff;border-color:var(--accent-2)}
    .danger{background:var(--danger);color:#ffffff;border-color:var(--danger)}

    /* Small helpers */
    .sep{height:1px;background:var(--border);margin:6px 0 2px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">2M</div>
      <h1>Rapporto di Intervento ‚Äì 2M Digital Consulting SRLS</h1>
    </header>

    <div class="card">
      <form id="form" autocomplete="on">
        <div class="row">
          <div>
            <label for="dtStart">Inizio intervento</label>
            <input id="dtStart" type="datetime-local" required autocomplete="on">
          </div>
          <div>
            <label for="dtEnd">Fine intervento</label>
            <input id="dtEnd" type="datetime-local" required autocomplete="on">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="cliente">Nome azienda o privato</label>
            <input id="cliente" type="text" placeholder="Es. Rossi Srl o Mario Rossi" required autocomplete="name">
          </div>
          <div>
            <label for="cfpiva">Codice fiscale o P. IVA (opzionale)</label>
            <input id="cfpiva" type="text" placeholder="CF / P.IVA" autocomplete="on" autocapitalize="characters">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="email">Email del cliente</label>
            <input id="email" type="email" inputmode="email" placeholder="cliente@esempio.it" required autocomplete="email">
          </div>
          <div class="inline" style="margin-top:32px">
            <input id="remoto" type="checkbox" aria-describedby="remotoHint">
            <label for="remoto" style="margin:0">Intervento da remoto</label>
          </div>
        </div>

        <div>
          <label for="luogo">Luogo dell‚Äôintervento</label>
          <input id="luogo" type="text" placeholder="Indirizzo / sede operativa" autocomplete="street-address">
          <div id="remotoHint" class="sr">Se spunti ‚Äúda remoto‚Äù, il campo luogo viene disattivato automaticamente.</div>
        </div>

        <div class="sep"></div>

        <div>
          <label for="desc">Descrizione intervento</label>
          <textarea id="desc" placeholder="Dettaglia attivit√† svolte, problemi risolti, eventuali consigli..." required></textarea>
        </div>

        <div class="totale" aria-live="polite">
          <div><strong>Totale ore</strong> (calcolo automatico)</div>
          <div class="pill" id="oreTot">‚Äî</div>
        </div>

        <div id="preview" class="preview" style="display:none;margin-top:10px"></div>
      </form>
    </div>

    <footer>
      ¬© 2M Digital Consulting SRLS ‚Äî info@2m-srls.com ‚Äî www.2m-srls.com
    </footer>
  </div>

  <!-- Sticky actions for easy thumb access -->
  <div class="actions-sticky" role="toolbar" aria-label="Azioni rapide">
    <button class="primary" type="button" id="sendBtn">Invia rapporto</button>
    <button class="ghost" type="button" id="previewBtn">Anteprima</button>
    <button class="success" type="button" id="copyBtn" title="Copia il corpo email negli appunti">Copia</button>
    <button class="danger" type="button" id="clearBtn" title="Pulisci tutti i campi">Pulisci</button>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const dtStart = $('#dtStart');
  const dtEnd   = $('#dtEnd');
  const cliente = $('#cliente');
  const cfpiva  = $('#cfpiva');
  const luogo   = $('#luogo');
  const remoto  = $('#remoto');
  const desc    = $('#desc');
  const email   = $('#email');
  const preview = $('#preview');
  const oreTot  = $('#oreTot');

  // Remote toggles location
  remoto.addEventListener('change', () => {
    if(remoto.checked){
      luogo.disabled = true; luogo.value='';
    } else {
      luogo.disabled = false;
    }
  });

  // Prefill start with now, end +1 hour
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const startISO = now.toISOString().slice(0,16);
  const end = new Date(now.getTime() + 60*60*1000);
  const endISO  = end.toISOString().slice(0,16);
  dtStart.value = startISO;
  dtEnd.value   = endISO;

  // Compute hours in real time
  [dtStart, dtEnd].forEach(el => el.addEventListener('change', updateHours));
  function toDateLocal(str){
    const d = new Date(str);
    return isNaN(d) ? null : d;
  }
  function humanHM(ms){
    const totalM = Math.round(ms/60000);
    const h = Math.floor(totalM/60);
    const m = totalM % 60;
    return `${h}h ${pad(m)}m`;
  }
  function hoursDecimal(ms){
    return Math.round((ms/3600000)*100)/100; // 2 dec
  }
  function updateHours(){
    const s = toDateLocal(dtStart.value);
    const e = toDateLocal(dtEnd.value);
    if(!s || !e){ oreTot.textContent = '‚Äî'; return; }
    let diff = e - s;
    if(diff < 0){
      while(diff < 0){ diff += 24*3600*1000; }
    }
    oreTot.textContent = `${hoursDecimal(diff)} h (${humanHM(diff)})`;
  }
  updateHours();

  function formatDateTime(value){
    if(!value) return '';
    const d = new Date(value);
    if(Number.isNaN(d.getTime())) return value;
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function buildBody(){
    const inizio = formatDateTime(dtStart.value);
    const fine   = formatDateTime(dtEnd.value);

    // compute diff again for email
    const s = toDateLocal(dtStart.value);
    const e = toDateLocal(dtEnd.value);
    let diff = (s && e) ? (e - s) : 0;
    if(diff < 0){ while(diff < 0){ diff += 24*3600*1000; } }
    const totOre = diff ? `${hoursDecimal(diff)} h (${humanHM(diff)})` : '‚Äî';

    const rigaLuogo = remoto.checked ? 'Da remoto' : (luogo.value || '‚Äî');
    const idFiscale = (cfpiva.value || '‚Äî');

    return [
      'Gentile Cliente,',
      '',
      'le inviamo il rapporto dell‚Äôintervento tecnico eseguito.',
      '',
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
      'üßæ  Dettagli intervento',
      `‚Ä¢ Inizio: ${inizio || '‚Äî'}`,
      `‚Ä¢ Fine: ${fine || '‚Äî'}`,
      `‚Ä¢ Totale ore: ${totOre}`,
      `‚Ä¢ Cliente: ${cliente.value || '‚Äî'}`,
      `‚Ä¢ CF / P.IVA: ${idFiscale}`,
      `‚Ä¢ Luogo: ${rigaLuogo}`,
      '',
      'üõ†Ô∏è  Descrizione attivit√†',
      (desc.value || '‚Äî'),
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
      '',
      'Per qualsiasi chiarimento pu√≤ rispondere a questa email.',
      '',
      'Cordiali saluti,',
      '',
      '‚Äî',
      '2M Digital Consulting SRLS',
      'Email: info@2m-srls.com',
      'Web: www.2m-srls.com',
      'Tel: 389 6038512 (Marco C.) ‚Ä¢ 389 5989659 (Marco L.)'
    ].join('\\n');
  }

  function buildSubject(){
    const inizio = formatDateTime(dtStart.value);
    return `Rapporto intervento ‚Äì 2M Digital Consulting SRLS ‚Äì ${inizio || ''}`.trim();
  }

  function validate(){
    if(!dtStart.value){ alert('Inserisci data e ora di inizio.'); dtStart.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
    if(!dtEnd.value){ alert('Inserisci data e ora di fine.'); dtEnd.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
    if(!cliente.value.trim()){ alert('Inserisci il nome azienda/privato.'); cliente.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
    if(!email.value.trim()){ alert('Inserisci l‚Äôemail del cliente.'); email.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
    if(!desc.value.trim()){ alert('Inserisci una descrizione dell‚Äôintervento.'); desc.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
    if(!remoto.checked && !luogo.value.trim()){
      alert('Inserisci il luogo dell‚Äôintervento oppure seleziona "Intervento da remoto".');
      luogo.scrollIntoView({behavior:'smooth',block:'center'});
      return false;
    }
    return true;
  }

  function openMailClient(){
    if(!validate()) return;
    const to = email.value.trim();
    const subject = buildSubject();
    const body = buildBody();
    const enc = encodeURIComponent;
    let url = `mailto:${enc(to)}?subject=${enc(subject)}&cc=${enc('info@2m-srls.com')}&body=${enc(body)}`;
    if(url.length > 1800){
      navigator.clipboard?.writeText(body).then(()=>{
        alert('Il testo completo √® stato copiato negli appunti (il messaggio √® molto lungo). Incollalo nella Mail se non appare tutto.');
      }).catch(()=>{});
      const shortBody = body.slice(0,1200) + '\\n\\n[Continua negli appunti]';
      url = `mailto:${enc(to)}?subject=${enc(subject)}&cc=${enc('info@2m-srls.com')}&body=${enc(shortBody)}`;
    }
    window.location.href = url;
  }

  function showPreview(){
    if(!validate()) return;
    preview.textContent = buildBody();
    preview.style.display = 'block';
    preview.scrollIntoView({behavior:'smooth',block:'center'});
  }

  function copyBody(){
    if(!validate()) return;
    const body = buildBody();
    navigator.clipboard?.writeText(body).then(()=>{
      const btn = document.getElementById('copyBtn');
      const old = btn.textContent;
      btn.textContent = 'Copiato!';
      setTimeout(()=> btn.textContent = old, 1200);
    }).catch(()=>{
      alert('Non √® stato possibile copiare negli appunti.');
    });
  }

  function clearAll(){
    document.getElementById('form').reset();
    // Re-set default times
    const now2 = new Date();
    now2.setMinutes(now2.getMinutes() - now2.getTimezoneOffset());
    dtStart.value = now2.toISOString().slice(0,16);
    const end2 = new Date(now2.getTime() + 60*60*1000);
    dtEnd.value = end2.toISOString().slice(0,16);
    updateHours();
    preview.style.display = 'none';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  document.getElementById('sendBtn').addEventListener('click', openMailClient);
  document.getElementById('previewBtn').addEventListener('click', showPreview);
  document.getElementById('copyBtn').addEventListener('click', copyBody);
  document.getElementById('clearBtn').addEventListener('click', clearAll);
})(); 
</script>
</body>
</html>
