<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Rapporto Intervento – 2M Digital Consulting SRLS</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    :root{
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #1b1b1f;
      --muted: #6b7280;
      --accent: #1f6feb;
      --accent-press: #1655b8;
      --border: #e5e7eb;
      --ok: #16a34a;
      --warn: #f59e0b;
      --danger: #dc2626;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Inter, Roboto, "Segoe UI", system-ui, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--text);
    }
    .wrap{max-width:720px;margin:0 auto;padding:env(safe-area-inset-top) 16px calc(92px + env(safe-area-inset-bottom));}
    header{position:sticky;top:0;background:var(--bg);padding:12px 16px 8px;backdrop-filter:saturate(1.2) blur(8px);z-index:5;border-bottom:1px solid var(--border);} 
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#e5eefc,#c3dafe 35%,#93c5fd);box-shadow:inset 0 0 0 2px #fff, var(--shadow);} 
    .brand b{letter-spacing:.2px}

    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:14px; margin:12px 0;}
    .section-title{font-size:15px;font-weight:700;margin:6px 2px 10px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}

    label{display:block;font-size:13px;color:var(--muted);margin:10px 2px 6px}
    input, textarea, select{
      width:100%; font-size:16px; padding:12px 12px; border-radius:12px; border:1px solid var(--border); background:#fff; color:var(--text);
      -webkit-appearance:none; appearance:none; outline:none; transition:.15s border-color ease;
    }
    input:focus, textarea:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(31,111,235,.12)}
    textarea{min-height:110px; resize:vertical}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#f3f4f6;border:1px solid var(--border);padding:2px 6px;border-radius:6px}

    .toggle{display:flex; align-items:center; gap:10px;}
    .toggle input{width:auto}

    .pill{display:inline-flex;align-items:center; gap:6px; font-size:12px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff}
    .pill.ok{border-color:#c7f0d2; background:#ecfdf5}
    .pill.warn{border-color:#fde68a; background:#fffbeb}

    .footer{
      position:fixed; left:0; right:0; bottom:0; padding:10px 16px calc(8px + env(safe-area-inset-bottom)); background:rgba(247,247,251,.9); backdrop-filter: blur(8px) saturate(1.1); border-top:1px solid var(--border);
    }
    .actions{display:flex; gap:10px;}
    .btn{flex:1;border:none;border-radius:14px;padding:14px 16px;font-size:16px;font-weight:700;letter-spacing:.2px;cursor:pointer}
    .btn.primary{background:var(--accent); color:white}
    .btn.primary:active{background:var(--accent-press)}
    .btn.secondary{background:white;border:1px solid var(--border)}

    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace}

    .grid-gap{display:grid;gap:10px}

    .error{border-color:var(--danger)!important}
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="logo" aria-hidden="true"></span> <div><div style="font-size:12px;color:var(--muted);line-height:1">Mini app</div><b>Rapporto Intervento</b></div></div>
  </header>

  <div class="wrap">
    <form id="form" class="grid-gap" autocomplete="on">
      <div class="card">
        <div class="section-title">Dati cliente</div>
        <label for="cliente">Nome azienda o privato</label>
        <input id="cliente" name="cliente" placeholder="Es. Rossi Srl o Mario Rossi" required />

        <label for="cfpiva">Codice Fiscale / Partita IVA</label>
        <input id="cfpiva" name="cfpiva" placeholder="Es. RSSMRA80A01H501U o IT01234567890" />

        <label for="email">Email del cliente</label>
        <input id="email" name="email" type="email" placeholder="esempio@dominio.it" />
      </div>

      <div class="card">
        <div class="section-title">Quando</div>
        <div class="row">
          <div>
            <label for="inizio">Data e ora di inizio</label>
            <input id="inizio" name="inizio" type="datetime-local" required />
          </div>
          <div>
            <label for="fine">Data e ora di fine</label>
            <input id="fine" name="fine" type="datetime-local" required />
          </div>
        </div>
        <div class="inline" style="margin-top:10px">
          <span class="pill ok" id="durataPill">Durata: <span id="durata" class="mono">—</span></span>
          <span class="pill warn" id="statusPill" style="display:none"></span>
        </div>
        <div class="hint">La durata viene calcolata automaticamente dalla differenza tra inizio e fine.</div>
      </div>

      <div class="card">
        <div class="section-title">Dove</div>
        <div class="toggle">
          <input type="checkbox" id="remoto" />
          <label for="remoto" style="margin:0">Intervento da remoto</label>
        </div>
        <label for="luogo" style="margin-top:10px">Luogo dell’intervento</label>
        <input id="luogo" name="luogo" placeholder="Via / Città / Presso…" />
        <div class="hint">Se selezioni "Intervento da remoto", il campo luogo verrà ignorato.</div>
      </div>

      <div class="card">
        <div class="section-title">Cosa</div>
        <label for="descrizione">Descrizione attività svolte</label>
        <textarea id="descrizione" name="descrizione" placeholder="Es. Diagnosi rete, aggiornamento software, sostituzione SSD…"></textarea>
      </div>

    </form>
  </div>

  <div class="footer">
    <div class="actions">
      <button class="btn secondary" type="button" id="resetBtn">Pulisci</button>
      <button class="btn primary" type="button" id="sendBtn">Invia rapporto di intervento</button>
    </div>
  </div>

<script>
  // ---- Helpers ----
  const $ = (sel) => document.querySelector(sel);
  const fmt = (date) => {
    if(!date) return "";
    const d = new Date(date);
    const pad = (n)=> String(n).padStart(2,'0');
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };
  const humanDuration = (ms) => {
    if (ms <= 0 || !Number.isFinite(ms)) return "—";
    const min = Math.round(ms/60000);
    const h = Math.floor(min/60);
    const m = min % 60;
    const hLabel = h === 1 ? "1 h" : `${h} h`;
    const mLabel = `(${String(h).padStart(1,'')}${h>0?'h ':''}${String(m).padStart(2,'0')}m)`;
    return h > 0 ? `${hLabel} ${mLabel}` : `${m} min`;
  };

  // ---- Elements ----
  const inizio = $('#inizio');
  const fine = $('#fine');
  const durata = $('#durata');
  const durataPill = $('#durataPill');
  const statusPill = $('#statusPill');
  const remoto = $('#remoto');
  const luogo = $('#luogo');
  const cliente = $('#cliente');
  const cfpiva = $('#cfpiva');
  const email = $('#email');
  const descrizione = $('#descrizione');

  // Prefill date-time with now and +1h
  const now = new Date();
  const plus1h = new Date(now.getTime()+60*60*1000);
  inizio.value = new Date(now - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
  fine.value = new Date(plus1h - plus1h.getTimezoneOffset()*60000).toISOString().slice(0,16);

  function updateDuration(){
    const t1 = new Date(inizio.value);
    const t2 = new Date(fine.value);
    const ms = t2 - t1;
    durata.textContent = humanDuration(ms);

    // status checks
    if (!inizio.value || !fine.value) { statusPill.style.display='none'; return; }
    if (ms < 0){ statusPill.textContent = '⚠️ Fine precedente all\'inizio'; statusPill.style.display='inline-flex';
    } else if (ms === 0){ statusPill.textContent = '⏱️ Durata 0 min'; statusPill.style.display='inline-flex';
    } else { statusPill.style.display='none'; }
  }

  inizio.addEventListener('change', updateDuration);
  fine.addEventListener('change', updateDuration);
  updateDuration();

  // Remote toggle behavior
  function syncLuogo(){
    if (remoto.checked){
      luogo.setAttribute('disabled','disabled');
      luogo.classList.add('mono');
    } else {
      luogo.removeAttribute('disabled');
      luogo.classList.remove('mono');
    }
  }
  remoto.addEventListener('change', syncLuogo);
  syncLuogo();

  // Local storage (simple autosave)
  const LS_KEY = 'rapporto-intervento-v1';
  function save(){
    const data = {
      cliente: cliente.value,
      cfpiva: cfpiva.value,
      email: email.value,
      inizio: inizio.value,
      fine: fine.value,
      remoto: remoto.checked,
      luogo: luogo.value,
      descrizione: descrizione.value
    };
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }
  function load(){
    try{ const raw = localStorage.getItem(LS_KEY); if(!raw) return; const d = JSON.parse(raw);
      cliente.value = d.cliente || '';
      cfpiva.value = d.cfpiva || '';
      email.value = d.email || '';
      inizio.value = d.inizio || inizio.value;
      fine.value = d.fine || fine.value;
      remoto.checked = !!d.remoto; syncLuogo();
      luogo.value = d.luogo || '';
      descrizione.value = d.descrizione || '';
      updateDuration();
    }catch(e){}
  }
  load();
  document.getElementById('form').addEventListener('input', save);

  // Validation helper
  function markInvalid(el, invalid){ el.classList.toggle('error', !!invalid); }
  function requireFilled(el){ const ok = !!el.value?.trim(); markInvalid(el, !ok); return ok; }

  // Build email
  function buildEmail(){
    const ok = [requireFilled(cliente), requireFilled(inizio), requireFilled(fine)];
    if (!ok.every(Boolean)){
      alert('Compila almeno: Cliente, Inizio e Fine.');
      return null;
    }
    const startTxt = fmt(inizio.value);
    const endTxt = fmt(fine.value);
    const ms = new Date(fine.value) - new Date(inizio.value);
    const durataTxt = humanDuration(ms);

    const luogoTxt = remoto.checked ? 'Intervento da remoto' : (luogo.value?.trim() || '—');
    const clientName = cliente.value.trim();
    const cfpiTxt = cfpiva.value?.trim() || '—';
    const descTxt = (descrizione.value?.trim() || 'Prova');

    const separator = '──────────────────────────────';

    const lines = [
      'Gentile Cliente,',
      '',
      'Le inviamo il rapporto relativo all\'intervento tecnico effettuato.',
      '',
      separator,
      '📋 Dettagli dell\'intervento',
      `- Data e ora di inizio: ${startTxt}`,
      `- Data e ora di fine: ${endTxt}`,
      `- Durata totale: ${durataTxt}`,
      `- Cliente: ${clientName}`,
      `- Codice Fiscale / Partita IVA: ${cfpiTxt}`,
      `- Luogo: ${luogoTxt}`,
      separator,
      '',
      '🛠 Descrizione attività svolte',
      descTxt,
      '',
      separator,
      'Per qualsiasi chiarimento, non esiti a contattarci rispondendo a questa e-mail.',
      '',
      'Cordiali saluti,',
      '',
      '—',
      '2M Digital Consulting SRLS  ',
      'Email: info@2m-srls.com  ',
      'Web: www.2m-srls.com  ',
      'Tel: 389 6038512 (Marco C.) – 389 5989659 (Marco L.)'
    ];

    const body = encodeURIComponent(lines.join('\n'));

    const subject = encodeURIComponent('Rapporto intervento tecnico – 2M Digital Consulting SRLS');

    // Preferisci inviare al cliente se presente; altrimenti lascia vuoto per scegliere dall'app Mail
    const to = (email.value && email.validity.valid) ? encodeURIComponent(email.value.trim()) : '';

    const href = `mailto:${to}?subject=${subject}&body=${body}`;
    return href;
  }

  // Buttons
  document.getElementById('sendBtn').addEventListener('click', () => {
    const mailto = buildEmail();
    if (!mailto) return;
    // iOS mailto launch
    window.location.href = mailto;
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    if(!confirm('Sicuro di voler svuotare il modulo?')) return;
    localStorage.removeItem(LS_KEY);
    document.getElementById('form').reset();
    remoto.checked = false; syncLuogo();
    updateDuration();
  });
</script>
</body>
</html>
