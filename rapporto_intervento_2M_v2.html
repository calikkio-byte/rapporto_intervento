<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Rapporto Intervento ‚Äì 2M Digital Consulting SRLS</title>
  <style>
    :root{
      --bg:#0a0b0e;
      --card:#14171d;
      --ink:#f2f4fa;
      --muted:#aeb4c2;
      --accent:#4da3ff;
      --accent-2:#6be585;
      --danger:#ff6b6b;
      --field:#0d1016;
      --border:#232835;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
    html,body{height:100%}
    html{background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;-webkit-text-size-adjust:100%}
    body{margin:0;display:flex;justify-content:center}
    .wrap{width:100%;max-width:780px;padding:20px env(safe-area-inset-right) calc(24px + env(safe-area-inset-bottom)) env(safe-area-inset-left)}
    header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
    .logo{
      width:44px;height:44px;border-radius:12px;
      background: linear-gradient(135deg,var(--accent),var(--accent-2));
      display:grid;place-items:center;font-weight:800;color:#03121f;letter-spacing:.3px;
      box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 20px rgba(255,255,255,.15);
    }
    h1{font-size:1.2rem;line-height:1.2;margin:0}
    .hint{font-size:.92rem;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 26px rgba(0,0,0,.35)}
    form{display:grid;gap:14px}
    label{display:block;font-size:.95rem;color:var(--muted);margin-bottom:7px}
    input[type="text"],input[type="email"],input[type="datetime-local"],textarea{
      width:100%;padding:14px 15px;border-radius:12px;border:1px solid var(--border);background:var(--field);color:var(--ink);
      outline:none;font-size:16px; /* prevents iOS zoom */
    }
    input:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(77,163,255,.18)}
    textarea{min-height:150px;resize:vertical}
    .row{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:700px){.row{grid-template-columns:1fr 1fr}}
    .inline{display:flex;align-items:center;gap:10px}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
    @media(min-width:520px){.actions{grid-template-columns:repeat(4,1fr)}}
    button{
      appearance:none;border:1px solid var(--border);border-radius:14px;padding:14px 16px;font-weight:700;cursor:pointer;font-size:16px;
      transition:transform .06s ease, opacity .15s ease;
    }
    button:active{transform:scale(.98);}
    .primary{background:var(--accent);color:#04111f;border-color:transparent}
    .ghost{background:transparent;color:var(--ink)}
    .success{background:var(--accent-2);color:#062112;border-color:transparent}
    .danger{background:var(--danger);color:#2b0101;border-color:transparent}
    .preview{white-space:pre-wrap;background:#0b0e14;border:1px dashed var(--border);border-radius:12px;padding:12px;font-size:.98rem;color:#e5e9f4}
    .totale{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0e1218;border:1px solid var(--border);border-radius:12px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(77,163,255,.15);color:#cfe5ff;font-weight:700}
    footer{margin-top:16px;color:var(--muted);font-size:.9rem;text-align:center}
    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">2M</div>
      <div>
        <h1>Rapporto di Intervento ‚Äì 2M Digital Consulting SRLS</h1>
        <div class="hint">Ottimizzato per iPhone 15 Pro Max ‚Ä¢ Aggiungi alla Home per usarlo come un‚Äôapp.</div>
      </div>
    </header>

    <div class="card">
      <form id="form" autocomplete="on">
        <div class="row">
          <div>
            <label for="dtStart">Inizio intervento</label>
            <input id="dtStart" type="datetime-local" required>
          </div>
          <div>
            <label for="dtEnd">Fine intervento</label>
            <input id="dtEnd" type="datetime-local" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="cliente">Nome azienda o privato</label>
            <input id="cliente" type="text" placeholder="Es. Rossi Srl o Mario Rossi" required>
          </div>
          <div>
            <label for="cfpiva">Codice fiscale o P. IVA (opzionale)</label>
            <input id="cfpiva" type="text" placeholder="CF / P.IVA">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="email">Email del cliente</label>
            <input id="email" type="email" inputmode="email" placeholder="cliente@esempio.it" required>
          </div>
          <div class="inline" style="margin-top:32px">
            <input id="remoto" type="checkbox" aria-describedby="remotoHint">
            <label for="remoto" style="margin:0">Intervento da remoto</label>
          </div>
        </div>

        <div>
          <label for="luogo">Luogo dell‚Äôintervento</label>
          <input id="luogo" type="text" placeholder="Indirizzo / sede operativa">
          <div id="remotoHint" class="hint">Se spunti ‚Äúda remoto‚Äù, il campo luogo viene disattivato automaticamente.</div>
        </div>

        <div>
          <label for="desc">Descrizione intervento</label>
          <textarea id="desc" placeholder="Dettaglia attivit√† svolte, problemi risolti, eventuali consigli..." required></textarea>
        </div>

        <div class="totale">
          <div>Totale ore (calcolo automatico)</div>
          <div class="pill" id="oreTot">‚Äî</div>
        </div>

        <div class="actions">
          <button class="primary" type="button" id="sendBtn">Invia rapporto di intervento</button>
          <button class="ghost" type="button" id="previewBtn">Anteprima</button>
          <button class="success" type="button" id="copyBtn" title="Copia il corpo email negli appunti">Copia corpo email</button>
          <button class="danger" type="reset">Pulisci</button>
        </div>

        <div id="preview" class="preview" style="display:none;margin-top:8px"></div>
      </form>
    </div>

    <footer>
      ¬© 2M Digital Consulting SRLS ‚Äî info@2m-srls.com ‚Äî www.2m-srls.com
    </footer>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const dtStart = $('#dtStart');
  const dtEnd   = $('#dtEnd');
  const cliente = $('#cliente');
  const cfpiva  = $('#cfpiva');
  const luogo   = $('#luogo');
  const remoto  = $('#remoto');
  const desc    = $('#desc');
  const email   = $('#email');
  const preview = $('#preview');
  const oreTot  = $('#oreTot');

  // iPhone friendly focus scroll
  function scrollIntoViewIfNeeded(el){
    el.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // Remote toggles location
  remoto.addEventListener('change', () => {
    if(remoto.checked){
      luogo.disabled = true; luogo.value='';
    } else {
      luogo.disabled = false;
    }
  });

  // Prefill start with now, end +1 hour
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const startISO = now.toISOString().slice(0,16);
  const end = new Date(now.getTime() + 60*60*1000);
  const endISO  = end.toISOString().slice(0,16);
  dtStart.value = startISO;
  dtEnd.value   = endISO;

  // Compute hours in real time
  [dtStart, dtEnd].forEach(el => el.addEventListener('change', updateHours));
  function toDateLocal(str){
    const d = new Date(str);
    return isNaN(d) ? null : d;
  }
  function humanHM(ms){
    const totalM = Math.round(ms/60000);
    const h = Math.floor(totalM/60);
    const m = totalM % 60;
    return `${h}h ${pad(m)}m`;
  }
  function hoursDecimal(ms){
    return Math.round((ms/3600000)*100)/100; // 2 dec
  }
  function updateHours(){
    const s = toDateLocal(dtStart.value);
    const e = toDateLocal(dtEnd.value);
    if(!s || !e){ oreTot.textContent = '‚Äî'; return; }
    let diff = e - s;
    if(diff < 0){
      // assume passaggio oltre mezzanotte; aggiungi giorni finch√© positivo (copre turni lunghi)
      while(diff < 0){ diff += 24*3600*1000; }
    }
    oreTot.textContent = `${hoursDecimal(diff)} h (${humanHM(diff)})`;
  }
  updateHours();

  function formatDateTime(value){
    if(!value) return '';
    const d = new Date(value);
    if(Number.isNaN(d.getTime())) return value;
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function buildBody(){
    const inizio = formatDateTime(dtStart.value);
    const fine   = formatDateTime(dtEnd.value);

    // compute diff again for email
    const s = toDateLocal(dtStart.value);
    const e = toDateLocal(dtEnd.value);
    let diff = (s && e) ? (e - s) : 0;
    if(diff < 0){
      while(diff < 0){ diff += 24*3600*1000; }
    }
    const totOre = diff ? `${hoursDecimal(diff)} h (${humanHM(diff)})` : '‚Äî';

    const rigaLuogo = remoto.checked ? 'Da remoto' : (luogo.value || '‚Äî');
    const idFiscale = (cfpiva.value || '‚Äî');

    return [
      'Gentile Cliente,',
      '',
      'le inviamo il rapporto dell‚Äôintervento tecnico eseguito.',
      '',
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
      'üßæ  Dettagli intervento',
      `‚Ä¢ Inizio: ${inizio || '‚Äî'}`,
      `‚Ä¢ Fine: ${fine || '‚Äî'}`,
      `‚Ä¢ Totale ore: ${totOre}`,
      `‚Ä¢ Cliente: ${cliente.value || '‚Äî'}`,
      `‚Ä¢ CF / P.IVA: ${idFiscale}`,
      `‚Ä¢ Luogo: ${rigaLuogo}`,
      '',
      'üõ†Ô∏è  Descrizione attivit√†',
      desc.value || '‚Äî',
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
      '',
      'Per qualsiasi chiarimento pu√≤ rispondere a questa email.',
      '',
      'Cordiali saluti,',
      '',
      '‚Äî',
      '2M Digital Consulting SRLS',
      'Email: info@2m-srls.com',
      'Web: www.2m-srls.com',
      'Tel: 389 6038512 (Marco C.) ‚Ä¢ 389 5989659 (Marco L.)'
    ].join('\n');
  }

  function buildSubject(){
    const inizio = formatDateTime(dtStart.value);
    return `Rapporto intervento ‚Äì 2M Digital Consulting SRLS ‚Äì ${inizio || ''}`.trim();
  }

  function openMailClient(){
    // Basic validation
    if(!dtStart.value){ alert('Inserisci data e ora di inizio.'); scrollIntoViewIfNeeded(dtStart); return; }
    if(!dtEnd.value){ alert('Inserisci data e ora di fine.'); scrollIntoViewIfNeeded(dtEnd); return; }
    if(!cliente.value.trim()){ alert('Inserisci il nome azienda/privato.'); scrollIntoViewIfNeeded(cliente); return; }
    if(!email.value.trim()){ alert('Inserisci l‚Äôemail del cliente.'); scrollIntoViewIfNeeded(email); return; }
    if(!desc.value.trim()){ alert('Inserisci una descrizione dell‚Äôintervento.'); scrollIntoViewIfNeeded(desc); return; }
    if(!remoto.checked && !luogo.value.trim()){
      alert('Inserisci il luogo dell‚Äôintervento oppure seleziona "Intervento da remoto".');
      scrollIntoViewIfNeeded(luogo);
      return;
    }

    const to = email.value.trim();
    const subject = buildSubject();
    const body = buildBody();

    const enc = encodeURIComponent;
    let url = `mailto:${enc(to)}?subject=${enc(subject)}&cc=${enc('info@2m-srls.com')}&body=${enc(body)}`;

    if(url.length > 1800){
      navigator.clipboard?.writeText(body).then(()=>{
        alert('Il testo completo √® stato copiato negli appunti (il messaggio √® molto lungo). Incollalo nella Mail se non appare tutto.');
      }).catch(()=>{});
      const shortBody = body.slice(0,1200) + '\n\n[Continua negli appunti]';
      url = `mailto:${enc(to)}?subject=${enc(subject)}&cc=${enc('info@2m-srls.com')}&body=${enc(shortBody)}`;
    }

    window.location.href = url;
  }

  function showPreview(){
    preview.textContent = buildBody();
    preview.style.display = 'block';
    preview.scrollIntoView({behavior:'smooth',block:'center'});
  }

  function copyBody(){
    const body = buildBody();
    navigator.clipboard?.writeText(body).then(()=>{
      const btn = document.getElementById('copyBtn');
      const old = btn.textContent;
      btn.textContent = 'Copiato!';
      setTimeout(()=> btn.textContent = old, 1200);
    }).catch(()=>{
      alert('Non √® stato possibile copiare negli appunti.');
    });
  }

  document.getElementById('sendBtn').addEventListener('click', openMailClient);
  document.getElementById('previewBtn').addEventListener('click', showPreview);
  document.getElementById('copyBtn').addEventListener('click', copyBody);
})(); 
</script>
</body>
</html>
